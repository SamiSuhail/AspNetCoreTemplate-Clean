volumes:
    db_volume:                                
        name: db_volume
    rabbitmq_volume:
        name: rabbitmq_volume

services:
    db:
        image: postgres
        container_name: db
        hostname: ${DB_INTERNAL_HOST}
        ports:
            - ${DB_PORT}:${DB_PORT}
        volumes:
            - db_volume:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: ${DB_NAME}
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            
    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin
        restart: always
        ports:
            - ${DB_WEBUI_PORT}:80
        environment:
            PGADMIN_DEFAULT_EMAIL: postgres@example.com
            PGADMIN_DEFAULT_PASSWORD: postgres
            PGADMIN_CONFIG_SERVER_MODE: 'False'
            PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
        configs:
            - source: servers.json
              target: /pgadmin4/servers.json

    queue:
        image: rabbitmq:3-management
        container_name: queue
        hostname: ${QUEUE_INTERNAL_HOST}
        ports:
            - ${QUEUE_PORT}:${QUEUE_PORT}
            - ${QUEUE_WEBUI_PORT}:${QUEUE_WEBUI_PORT}
        volumes:
            - rabbitmq_volume:/var/lib/rabbitmq/data
        environment:
            RABBITMQ_DEFAULT_USER: ${QUEUE_USERNAME}
            RABBITMQ_DEFAULT_PASS: ${QUEUE_PASSWORD}

    email:
        image: greenmail/standalone:latest
        container_name: email
        hostname: ${EMAIL_INTERNAL_HOST}
        ports:
            - ${EMAIL_SMTP_PORT}:${EMAIL_SMTP_PORT}
            - ${EMAIL_POP3_PORT}:${EMAIL_POP3_PORT}
            - ${EMAIL_IMAP_PORT}:${EMAIL_IMAP_PORT}
            - ${EMAIL_SMTPS_PORT}:${EMAIL_SMTPS_PORT}
            - ${EMAIL_POP3S_PORT}:${EMAIL_POP3S_PORT}
            - ${EMAIL_IMAPS_PORT}:${EMAIL_IMAPS_PORT}
            - ${EMAIL_API_PORT}:8080
        environment:
            GREENMAIL_USERS: ${EMAIL_USERDEFAULT_EMAILADDRESS}:${EMAIL_USERDEFAULT_PASSWORD},${EMAIL_USEROTHER_EMAILADDRESS}:${EMAIL_USEROTHER_PASSWORD}

configs:
    servers.json:
        content: |
            {
                "Servers": {
                    "1": {
                        "Group": "Servers",
                        "Name": "docker",
                        "Host": "${DB_INTERNAL_HOST}",
                        "Port": 5432,
                        "MaintenanceDB": "postgres",
                        "Username": "${DB_USERNAME}",
                        "SSLMode": "prefer"
                    }
                }
            }